<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronizar Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-3xl font-bold mb-4">Sincronizar Clientes</h1>
        <p class="text-gray-600 mb-4">Esta página irá criar clientes baseado nos agendamentos existentes</p>
        
        <div id="result" class="mb-4 p-4 rounded hidden"></div>
        
        <button onclick="syncCustomers()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
            Sincronizar Agora
        </button>
    </div>

    <script>
        const SUPABASE_URL = 'https://kxdmigytkedpahccfraa.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4ZG1pZ3l0a2VkcGFoY2NmcmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDkxMjAsImV4cCI6MjA4MzcyNTEyMH0.-QQCRguA4oPqM3p4Mpq7JB8XEmhdj5VlT62K_TS2q4o'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        async function syncCustomers() {
            try {
                const resultDiv = document.getElementById('result')
                resultDiv.innerHTML = '<p class="text-blue-600">Sincronizando...</p>'
                resultDiv.classList.remove('hidden')

                // Pegar a sessão
                const { data: { session } } = await supabase.auth.getSession()
                if (!session) {
                    throw new Error('Você precisa estar logado')
                }

                // Pegar tenant
                const { data: tenant } = await supabase
                    .from('tenants')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .single()

                if (!tenant) {
                    throw new Error('Salão não encontrado')
                }

                // Buscar todos os agendamentos
                const { data: appointments } = await supabase
                    .from('appointments')
                    .select('*')
                    .eq('tenant_id', tenant.id)

                if (!appointments || appointments.length === 0) {
                    resultDiv.innerHTML = '<p class="text-yellow-600">Nenhum agendamento encontrado</p>'
                    return
                }

                // Criar um Map de clientes únicos por whatsapp
                const customersMap = new Map()
                
                appointments.forEach(apt => {
                    const key = apt.cliente_whatsapp || apt.cliente_nome
                    if (!customersMap.has(key)) {
                        customersMap.set(key, {
                            tenant_id: tenant.id,
                            nome: apt.cliente_nome,
                            email: apt.cliente_email || null,
                            whatsapp: apt.cliente_whatsapp || null,
                            total_agendamentos: 0,
                            total_cancelamentos: 0,
                            total_gasto: 0,
                            primeiro_agendamento: apt.data_agendamento,
                            ultimo_agendamento: apt.data_agendamento
                        })
                    }
                    
                    const customer = customersMap.get(key)
                    customer.total_agendamentos += 1
                    if (apt.status === 'cancelado') {
                        customer.total_cancelamentos += 1
                    }
                    customer.ultimo_agendamento = apt.data_agendamento
                })

                // Buscar clientes existentes
                const { data: existingCustomers } = await supabase
                    .from('customers')
                    .select('whatsapp, nome')
                    .eq('tenant_id', tenant.id)

                const existingWhatsapps = new Set(existingCustomers?.map(c => c.whatsapp) || [])
                const existingNames = new Set(existingCustomers?.map(c => c.nome) || [])

                // Inserir apenas os novos clientes
                const newCustomers = Array.from(customersMap.values()).filter(c => {
                    return !existingWhatsapps.has(c.whatsapp) && !existingNames.has(c.nome)
                })

                if (newCustomers.length === 0) {
                    resultDiv.innerHTML = '<p class="text-green-600">Todos os clientes já existem!</p>'
                    return
                }

                const { error } = await supabase
                    .from('customers')
                    .insert(newCustomers)

                if (error) throw error

                resultDiv.innerHTML = `<p class="text-green-600">✓ ${newCustomers.length} cliente(s) criado(s) com sucesso!</p>`
            } catch (error) {
                console.error('Erro:', error)
                resultDiv.innerHTML = `<p class="text-red-600">Erro: ${error.message}</p>`
                resultDiv.classList.remove('hidden')
            }
        }
    </script>
</body>
</html>
